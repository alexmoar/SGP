{% extends 'base.html' %}

{% load static %}

{% block body_tags %}class="with-content-panel"{% endblock %}

{% block extra_css %}
    <link href="{% static 'icon_fonts_assets/batch-icons/style.css' %}" rel="stylesheet">


    <link href="{% static 'css/gallery.css' %}" rel="stylesheet">
    <style>
        .content-answer {
            padding: 12px 15px;
            background: #f4f4f4;
            border: 1px solid #f4f4f4;
            margin-bottom: 15px;
        }
        .add-item {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 30%;
            width: 100%;
            opacity: .5;
            cursor: pointer;
            background-color: rgba(238, 238, 238, 0.5)
        }

        .add-item:hover {
            opacity: 1;
        }

        .add-item i {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .add-item span {
            font-size: 1.5rem;
            text-align: center;
        }

        .bg-item {
            background-color: rgba(238, 238, 238, 0.5)
        }

        a.disabled {
            pointer-events: none;
            cursor: default;
        }

        .title-resume-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .title-resume-item h5 {
            margin: 0;
        }

        .btn-delete-item {
            position: absolute;
            right: 22px;
            top: 5px;
        }
        .btn-delete-item,
        .btn-remove {
            padding: 12px 16px !important;
            font-weight: bold;
            background-color: #ffffff !important;
            border: 0;
            box-shadow: 0px 2px 4px rgb(126 142 177 / 12%);
            border-radius: 5px;
            z-index: 0;
            cursor: pointer !important;
            opacity: 1;
            font-size: 10px;
        }

        .btn-remove,
        .btn-delete-item span {
            font-weight: bold;
        }
        .btn-remove,
        .btn-delete-item:hover {
            color: red;
        }
    </style>
{% endblock extra_css %}


{% block content %}
    <div class="all-wrapper menu-side with-side-panel" id="app">
        <div class="layout-w">

            {% include 'writer/sidebar-left.html' %}

            <div class="content-w">
                <!--------------------  START - Breadcrumbs  -------------------->
                <ul class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url 'writer:dashboard' %}">Inicio</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{% url 'writer:list_projects' %}">Proyectos</a>
                    </li>
                    <li class="breadcrumb-item">
                        <span>{{ project.title }}</span>
                    </li>
                </ul>
                <!--------------------
                END - Breadcrumbs
                -------------------->
                <div class="content-i">
                    <div class="content-box">
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="element-wrapper">
                                    <h6 class="element-header">
                                        Agregar un nuevo proyecto
                                    </h6>
                                    <div class="element-box">
                                        <div class="steps">
                                            <div class="contents">
                                                {% include 'writer/edit/step_1.html' %}
                                                {% include 'writer/edit/step_2.html' %}
                                                {% include 'writer/edit/step_3.html' %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% csrf_token %}
    </div>
{% endblock %}

{% block extra_js %}

    <script src="https://unpkg.com/vue@3"></script>

    <script type="importmap">
      {
        "imports": {
          "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js"
        }
      }


    </script>

    <script type="module">

    import {createApp} from 'vue';

let app = createApp({
    delimiters: ['${', '}'],
    data() {
        return {
            show_intro: false,
            items: [1],
            questions: [],
            files: [],
            files_pdf: [],
            delete_questions: [],
            count: 1,
            id_project: {{project.id}},
            title: "{{ project.title }}",
            description: `{% autoescape off %}{{ project.description }}{% endautoescape %}`,
            categories: {{ categories_project }},
            disableStepOne: true,
            step: 1,
            status: "{{ project.status }}"
        }
    },
    created() {
        window.removeItem = this.removeItem;
    },
    mounted() {
        this.setDescription();
    },
    computed: {},
    methods: {
        setDescription() {
            if ($('#description').length) {
                CKEDITOR.replace('description');
                CKEDITOR.instances['description'].setData(`${this.description}`);
            }
        },
        changeStep(step) {
            window.scrollTo({top: 0, behavior: 'smooth'});
            this.step = step
        },
        saveSectionItems() {
            this.changeStep(3)
            let vm = this;
            fetch(
                "{% url 'projects:get_file' project.id %}"
            ).then(response => {
                if (response.status === 200) {
                    response.json()
                        .catch(error => console.log(error))
                        .then(response => {
                            console.log(response)
                            vm.files = response['files']
                            vm.renderFiles(response['files'])
                        });
                } else {
                    response.json()
                        .catch(error => console.log(error))
                        .then(response => {
                            console.error(response)
                        });
                }

            })
        },
        renderFiles(files) {
            console.log("::::", files)
            let html_input = "";
            let html_wrap = "";
            let html_thumbnails = "";
            let style = "";
            for(let i = 0; i<files.length; i++) {
                if (files[i]['type_file'] === 'pdf') continue
                html_input += `
                    <input type="radio" id="image${i+1}" name="gallery-control" ${i === 0 ? 'checked': '' }>
                `;

                html_wrap += `
                    <figure>
                        <label for="fullscreen">
                            <img src="${files[i]['file']}" alt="image${i+1}"/>
                        </label>
                    </figure>
                `;

                html_thumbnails += `
                    <label for="image${i+1}"
                           class="thumb"
                           style="background-image: url('${files[i]['file']}')"></label>
                `;

                style += `
                    .gallery input#image${i + 1}:checked ~ .wrap figure {
                        -webkit-transform: translateX(-${i}00%);
                        transform: translateX(-${i}00%);
                    }
                    .gallery input#image${i + 1}:checked ~ .wrap figure:not(:nth-of-type(${i + 1})) {
                        opacity: 0;
                    }
                    .gallery input#image${i + 1}:checked ~ .thumbnails .slider {
                        -webkit-transform: translateY(${i}00%);
                        transform: translateY(${i}00%);
                    }
                    .gallery input#image${i + 1}:checked ~ .thumbnails .thumb:nth-of-type(${i + 1}) {
                        opacity: 1;
                        cursor: default;
                    }
                `;


            }
            document.head.insertAdjacentHTML("beforeend", `<style>${style}</style>`)
            let carousel = document.getElementById('carousel');

            carousel.innerHTML = `
                ${html_input}
                <input type="checkbox" id="fullscreen" name="gallery-fullscreen-control"/>
                <div class="wrap">${html_wrap}</div>
                <div class="thumbnails">
                    <div class="slider">
                        <div class="indicator"></div>
                    </div>
                    ${html_thumbnails}
                </div>
            `;

        },
        createStyleGallery() {

        },
        fetchProject(step) {
            let vm = this;
            vm.categories = vm.getCategories()
            fetch("{% url 'writer:add_project' %}", {
                method: "put",
                body: JSON.stringify({
                    'id_project': vm.id_project,
                    'title': vm.title,
                    'description': vm.description,
                    'categories': vm.categories,
                    'status': vm.status
                }),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.getElementsByName('csrfmiddlewaretoken')[0].value
                }
            }).then(response => {
                if (response.status === 200) {
                    response.json()
                        .catch(error => console.log(error))
                        .then(response => {
                            console.log(response)
                            vm.id_project = response['id']
                            return this.changeStep(step)
                        });
                } else {
                    response.json()
                        .catch(error => console.log(error))
                        .then(response => {
                            console.error(response)
                        });
                }

            })
        },
        deleteItem(id) {
            let vm = this;
            vm.questions.filter(item => {
                if(item['id'] === id) {
                    item['delete'] = true
                }
            })
        },
        checkQuestionsProject() {
            let vm = this;
            fetch(
                "{% url 'writer:get_questions_project' project.id %}"
            ).then(response => {
                if (response.status === 200) {
                    response.json()
                        .catch(error => console.log(error))
                        .then(response => {
                            console.log(response['questions'])
                            vm.questions = response['questions'].map(item => {
                                item['delete'] = false
                                return item
                            })
                            vm.count = vm.questions.length
                            return this.fetchProject(2)
                        });
                } else {
                    response.json()
                        .catch(error => console.log(error))
                        .then(response => {
                            console.error(response)
                        });
                }

            })
        },
        checkDescription(id) {
            let vm = this;
            vm.questions.filter(item => {
                if(item['id'] === id) {
                    item['show'] = !item['show']
                    if(item['show']) {
                        let url = "{% url 'writer:get_question_detail' 0 %}";
                        url = url.replace('0', id);
                        fetch(
                            url
                        ).then(response => {
                            if (response.status === 200) {
                                response.json()
                                    .catch(error => console.log(error))
                                    .then(response => {
                                        console.log(response)
                                        item['answer'] = response['answer']
                                        let field = `answer-q-${id}`;

                                        if ($(`#${field}`).length) {
                                            let editor = CKEDITOR.instances[`${field}`];
                                            if (editor) {
                                                editor.destroy(true);
                                            }
                                            CKEDITOR.replace(`${field}`);
                                        }
                                    });
                            } else {
                                response.json()
                                    .catch(error => console.log(error))
                                    .then(response => {
                                        console.error(response)
                                    });
                            }

                        })
                    }
                }
            })

        },
        updateQuestion(id) {
            let title = document.getElementById(`title-q-${id}`).value
            let answer = this.getDescription(`answer-q-${id}`)
            let url = "{% url 'writer:get_question_detail' 0 %}";
            url = url.replace('0', id);
            fetch(url, {
                method: "put",
                body: JSON.stringify({
                    'id': id,
                    'title': title,
                    'answer': answer,
                }),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.getElementsByName('csrfmiddlewaretoken')[0].value
                }
            }).then(response => {
                if (response.status === 200) {
                    response.json()
                        .catch(error => console.log(error))
                        .then(response => {
                            console.log(response)
                        });
                } else {
                    response.json()
                        .catch(error => console.log(error))
                        .then(response => {
                            console.error(response)
                        });
                }

            })
        },
        saveDraft(step) {
            this.status = 'draft'
            this.fetchProject(step)
            this.saveQuestions()
        },
        saveQuestions() {
            let vm = this;
            let data = []
            for (let i = 0; i < this.items.length; i++) {
                let v = this.items[i]
                console.log("V: ", v)
                let title = document.getElementById(`title-${v}`).value
                let answer = this.getDescription(`answer-${this.items[i]}`)
                data.push({
                    'title': title,
                    'answer': answer,
                })
            }
            if(data) {
                fetch("{% url 'writer:add_questions' %}", {
                    method: "post",
                    body: JSON.stringify({
                        'id_project': vm.id_project,
                        'questions': data,
                    }),
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.getElementsByName('csrfmiddlewaretoken')[0].value
                    }
                }).then(response => {
                    if (response.status === 200) {
                        response.json()
                            .catch(error => console.log(error))
                            .then(response => {
                                console.log(response['id'])
                                vm.id_project = response['id']

                            });
                    } else {
                        response.json()
                            .catch(error => console.log(error))
                            .then(response => {
                                console.error(response)
                            });
                    }

                })
            }

        },
        enableStepActionOne() {
            let vm = this;
            window.setInterval(function () {
                vm.description = vm.getDescription('ckeditor-main')
                vm.categories = vm.getCategories()
                vm.disableStepOne = !(vm.title.length > 0 && vm.description.length > 0 && vm.categories.length > 0);
            }, 500);

        },
        getDescription(field) {
            if ($(`#${field}`).length) {
                return CKEDITOR.instances[field].getData()
            }
        },
        getCategories() {
            if ($('.select2').length) {
                return $("#categories").val()
            }
        },
        removeItem(item) {
            let el = document.getElementById(`item-${item}`)
            for (let i = 0; i < this.items.length; i++) {
                if (this.items[i] === parseInt(item)) {
                    this.items.splice(i, 1);
                    break;
                }
            }
            el.remove()
        },
        addItem() {
            this.count += 1;
            this.items.push(this.count)
            let it = document.getElementById(`item-${this.items[this.items.length - 2]}`);
            if (!it) {
                it = document.getElementById(`item-0`);
            }
            let i = document.createElement('div')
            i.setAttribute("class", "col-md-6");
            i.setAttribute("id", `item-${this.count}`);
            i.innerHTML = `
                        <div class="element-box bg-item">
                            <button class="close btn-delete-item" type="button" onclick="removeItem(${this.count})">
                                <span class="os-icon os-icon-close"></span>
                            </button>
                            <div class="form-group">
                                <label for="">Item #${this.count}</label>
                                <input class="form-control"
                                        name="title-${this.count}"
                                        id="title-${this.count}"
                                        placeholder="Agrega el contenido de tu pregunta"
                                        maxlength="255"
                                        type="text">
                            </div>
                            <div class="row">
                                <div class="col-sm-12">
                                    <h5 class="form-header">
                                        Respuesta
                                    </h5>
                                    <div class="form-desc">
                                        Agrega tu respuesta
                                    </div>
                                    <textarea cols="80" id="answer-${this.count}" name="answer-${this.count}"
                                              rows="10"></textarea>
                                </div>
                            </div>
                        </div>
                    `;

            it.insertAdjacentElement("afterend", i);
            if ($(`#answer-${this.count}`).length) {
                CKEDITOR.replace(`answer-${this.count}`);
            }
        }
    }
})

app.mount('#app')

    </script>


{% endblock extra_js %}
